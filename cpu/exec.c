//// Created by hxc on 2/1/17.//#include "reg.h"#define R_TYPE      0x00#define LW          0x23#define SW          0x2B#define BEQ         0x04#define J           0x02#define AND         0x24#define OR          0x25#define ADD         0x20#define SUB         0x22#define SLT         0x2A#define ALU_AND     0x00#define ALU_OR      0x01#define ALU_ADD     0x02#define ALU_SUB     0x06#define ALU_SLT     0x07enum {    Branch,    Jump,    RegWrite,    MemRead,    MemWrite,    ALUOp1,    ALUOp0,    ALUZero};typedef struct {    uint32_t ou0;    uint32_t ou1;} reg_data;uint8_t control_signal;uint32_t r_pc;uint32_t *inst_mem;uint32_t *data_mem;uint8_t alu_control_signal;inline staticuint8_t get_signal(uint8_t bit){    return (uint8_t)(control_signal & (1 << bit));}inline staticvoid set_signal(uint8_t bit){    control_signal |= 1 << bit;}inline staticuint8_t get_opcode(uint32_t inst){    return (uint8_t)((inst & 0xFC000000) >> 26);}inline staticuint8_t get_rs(uint32_t inst){    return (uint8_t)((inst & 0x03E00000) >> 21);}inline staticuint8_t get_rt(uint32_t inst){    return (uint8_t)((inst & 0x001F0000) >> 16);}inline staticuint8_t get_rd(uint32_t inst){    return (uint8_t)((inst & 0x0000F800) >> 11);}inline staticuint8_t get_shamt(uint32_t inst){    return (uint8_t)((inst & 0x000007C0) >> 6);}inline staticuint8_t get_funct(uint32_t inst){    return (uint8_t)(inst & 0x0000003F);}inline staticuint16_t get_immediate(uint32_t inst){    return (uint16_t)(inst & 0x0000FFFF);}inline staticuint32_t get_address(uint32_t inst){    return (inst & 0x03FFFFFF);}inline staticreg_data reg_file(uint8_t read0, uint8_t read1, uint8_t write, uint32_t write_data){    if (get_signal(RegWrite))        regs[write] = write_data;    reg_data tmp;    tmp.ou0 = regs[read0];    tmp.ou1 = regs[read1];    return tmp;}inline staticvoid pc(uint32_t new_pc){    if (!(get_signal(Branch) && !get_signal(ALUZero)))        r_pc = new_pc;}inline staticuint32_t data_mem_file(uint32_t addr, uint32_t write_data){    if (get_signal(MemWrite))        data_mem[addr/4] = write_data;    if (get_signal(MemRead))        return data_mem[addr/4];    return 0;}inline staticuint32_t inst_mem_file(uint32_t addr){    return inst_mem[addr/4];}inline staticuint32_t alu(uint32_t in0, uint32_t in1){    uint32_t tmp = 1;    switch (alu_control_signal) {        case ALU_AND:            tmp = in0 & in1;            break;        case ALU_OR:            tmp = in0 | in1;            break;        case ALU_ADD:            tmp = in0 + in1;            break;        case ALU_SUB:            tmp = in0 - in1;            break;        case ALU_SLT:            tmp = (in0 < in1) ? 0 : 1;            break;        default:            break;    }    if (tmp == 0)        set_signal(ALUZero);    return tmp;}inline staticvoid alu_control(uint8_t funct){    if (get_signal(ALUOp1) == 0) {        if (get_signal(ALUOp0)) {            alu_control_signal = ALU_SUB;        } else {            alu_control_signal = ALU_ADD;        }    } else {        switch (funct) {            case ADD:                alu_control_signal = ALU_ADD;                break;            case SUB:                alu_control_signal = ALU_SUB;                break;            case AND:                alu_control_signal = ALU_AND;                break;            case OR:                alu_control_signal = ALU_OR;                break;            case SLT:                alu_control_signal = ALU_SLT;                break;            default:                break;        }    }}inline staticvoid main_control(uint8_t inst){    switch (inst) {        case R_TYPE:            set_signal(RegWrite);            set_signal(ALUOp1);            break;        case SW:            set_signal(MemWrite);            break;        case LW:            set_signal(RegWrite);            set_signal(MemRead);            break;        case BEQ:            set_signal(Branch);            set_signal(ALUOp0);            break;        case J:            set_signal(Jump);            break;        default:            break;    }}void init(uint32_t *mem){    inst_mem = mem;    data_mem = mem + 0x1000;}void exec(void){    control_signal = 0;    uint32_t inst;    inst = inst_mem_file(r_pc);    pc(r_pc + 4);    main_control(get_opcode(inst));    alu_control(get_funct(inst));    reg_data tmp;    uint32_t res;    uint32_t addr;    switch (get_opcode(inst)) {        case R_TYPE:            tmp = reg_file(get_rs(inst), get_rt(inst), 0, 0);            res = alu(tmp.ou0, tmp.ou1);            reg_file(0, 0, get_rd(inst), res);            break;        case LW:            tmp = reg_file(get_rs(inst), get_rt(inst), 0, 0);            addr = alu(tmp.ou0, get_immediate(inst));            res = data_mem_file(addr, 0);            reg_file(0, 0, get_rt(inst), res);            break;        case SW:            tmp = reg_file(get_rs(inst), get_rt(inst), 0, 0);            addr = alu(tmp.ou0, get_immediate(inst));            data_mem_file(addr, tmp.ou1);            break;        case BEQ:            tmp = reg_file(get_rs(inst), get_rt(inst), 0, 0);            alu(tmp.ou0, tmp.ou1);            addr = ((int32_t)(int16_t)get_immediate(inst) << 2) + r_pc;            pc(addr);            break;        case J:            addr = r_pc & 0xF0000000 | (get_address(inst) << 2);            pc(addr);            break;        default:            break;    }}